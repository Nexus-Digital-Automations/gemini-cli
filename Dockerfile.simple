FROM docker.io/library/node:20-slim

ARG SANDBOX_NAME="gemini-cli-sandbox"
ARG CLI_VERSION_ARG
ENV SANDBOX="$SANDBOX_NAME"
ENV CLI_VERSION=$CLI_VERSION_ARG

# Install minimal set of packages, then clean up
RUN apt-get update && apt-get install -y --no-install-recommends \
  python3 \
  make \
  g++ \
  man-db \
  curl \
  dnsutils \
  less \
  jq \
  bc \
  gh \
  git \
  unzip \
  rsync \
  ripgrep \
  procps \
  psmisc \
  lsof \
  socat \
  ca-certificates \
  && apt-get clean \
  && rm -rf /var/lib/apt/lists/*

# Set up npm global package folder under /usr/local/share
# Give it to non-root user node, already set up in base image
RUN mkdir -p /usr/local/share/npm-global \
  && chown -R node:node /usr/local/share/npm-global
ENV NPM_CONFIG_PREFIX=/usr/local/share/npm-global
ENV PATH=$PATH:/usr/local/share/npm-global/bin

# Switch to non-root user node
USER node

# Set working directory
WORKDIR /usr/src/app

# Copy all source code
COPY --chown=node:node . .

# Install dependencies without running prepare scripts
RUN npm install --ignore-scripts

# Build only what we need for basic operation
RUN npm run generate

# Create a simple entrypoint script that runs the CLI in development mode
RUN mkdir -p /home/node/bin && \
    echo '#!/bin/bash' > /home/node/bin/entrypoint.sh && \
    echo 'echo "Gemini CLI Development Container"' >> /home/node/bin/entrypoint.sh && \
    echo 'echo "Budget System: ✓ Implemented"' >> /home/node/bin/entrypoint.sh && \
    echo 'echo "Progress Tracking: ✓ Implemented"' >> /home/node/bin/entrypoint.sh && \
    echo 'echo ""' >> /home/node/bin/entrypoint.sh && \
    echo 'echo "Available commands:"' >> /home/node/bin/entrypoint.sh && \
    echo 'echo "  npm run start [args] - Start the CLI"' >> /home/node/bin/entrypoint.sh && \
    echo 'echo "  npm run lint - Run linting"' >> /home/node/bin/entrypoint.sh && \
    echo 'echo "  npm run typecheck - Check TypeScript"' >> /home/node/bin/entrypoint.sh && \
    echo 'echo "  bash - Enter shell"' >> /home/node/bin/entrypoint.sh && \
    echo 'echo ""' >> /home/node/bin/entrypoint.sh && \
    echo 'echo "Example usage:"' >> /home/node/bin/entrypoint.sh && \
    echo 'echo "  npm run start -- --help"' >> /home/node/bin/entrypoint.sh && \
    echo 'echo "  npm run start -- budget --help"' >> /home/node/bin/entrypoint.sh && \
    echo 'echo ""' >> /home/node/bin/entrypoint.sh && \
    echo 'if [ "$#" -eq 0 ]; then' >> /home/node/bin/entrypoint.sh && \
    echo '  exec bash' >> /home/node/bin/entrypoint.sh && \
    echo 'else' >> /home/node/bin/entrypoint.sh && \
    echo '  exec "$@"' >> /home/node/bin/entrypoint.sh && \
    echo 'fi' >> /home/node/bin/entrypoint.sh && \
    chmod +x /home/node/bin/entrypoint.sh

# Set up environment for development
ENV NODE_ENV=development

# Default entrypoint
ENTRYPOINT ["/home/node/bin/entrypoint.sh"]
CMD []